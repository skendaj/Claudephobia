name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Import signing certificate
        env:
          CERTIFICATE_P12: ${{ secrets.CERTIFICATE_P12 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -hex 16)

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "$CERTIFICATE_P12" | base64 --decode > $RUNNER_TEMP/cert.p12
          security import $RUNNER_TEMP/cert.p12 \
            -k "$KEYCHAIN_PATH" \
            -P "$CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign
          rm $RUNNER_TEMP/cert.p12

          # Allow codesign to access keychain without prompt
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db

      - name: Build app bundle
        run: |
          swift build -c release

          APP="Claudephobia.app"
          CONTENTS="${APP}/Contents"
          mkdir -p "${CONTENTS}/MacOS" "${CONTENTS}/Resources"

          cp .build/release/Claudephobia "${CONTENTS}/MacOS/Claudephobia"
          cp Resources/Info.plist "${CONTENTS}/Info.plist"

          if [ -f "Resources/AppIcon.icns" ]; then
            cp "Resources/AppIcon.icns" "${CONTENTS}/Resources/AppIcon.icns"
          fi

          # Sign with Developer ID + hardened runtime + entitlements
          codesign --force --options runtime \
            --entitlements Resources/Claudephobia.entitlements \
            --sign "Developer ID Application: Bruno Skendaj (53CZ5753ZD)" \
            "${APP}"

          codesign --verify --verbose "${APP}"

      - name: Notarize
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        timeout-minutes: 30
        run: |
          zip -r Claudephobia.zip Claudephobia.app

          # Submit for notarization
          SUBMIT_OUTPUT=$(xcrun notarytool submit Claudephobia.zip \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --output-format json 2>&1) || true

          SUBMISSION_ID=$(echo "$SUBMIT_OUTPUT" | python3 -c "import sys,json; print(json.load(sys.stdin)['id'])" 2>/dev/null)

          if [ -z "$SUBMISSION_ID" ]; then
            echo "::error::Failed to submit for notarization"
            echo "$SUBMIT_OUTPUT"
            exit 1
          fi

          echo "Submission ID: $SUBMISSION_ID"

          # Poll for completion (up to 20 minutes)
          if xcrun notarytool wait "$SUBMISSION_ID" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --timeout 20m; then

            # Check final status
            STATUS=$(xcrun notarytool info "$SUBMISSION_ID" \
              --apple-id "$APPLE_ID" \
              --team-id "$APPLE_TEAM_ID" \
              --password "$APPLE_APP_PASSWORD" \
              --output-format json 2>/dev/null | python3 -c "import sys,json; print(json.load(sys.stdin)['status'])" 2>/dev/null)

            echo "Notarization status: $STATUS"

            if [ "$STATUS" = "Accepted" ]; then
              xcrun stapler staple Claudephobia.app
              rm Claudephobia.zip
              zip -r Claudephobia.zip Claudephobia.app
              echo "NOTARIZED=true" >> "$GITHUB_ENV"
            else
              echo "::warning::Notarization rejected. Fetching log..."
              xcrun notarytool log "$SUBMISSION_ID" \
                --apple-id "$APPLE_ID" \
                --team-id "$APPLE_TEAM_ID" \
                --password "$APPLE_APP_PASSWORD" || true
              echo "NOTARIZED=false" >> "$GITHUB_ENV"
            fi
          else
            echo "::warning::Notarization timed out. Fetching log..."
            xcrun notarytool log "$SUBMISSION_ID" \
              --apple-id "$APPLE_ID" \
              --team-id "$APPLE_TEAM_ID" \
              --password "$APPLE_APP_PASSWORD" || true
            echo "NOTARIZED=false" >> "$GITHUB_ENV"
          fi

      - name: Clean up keychain
        if: always()
        run: security delete-keychain $RUNNER_TEMP/signing.keychain-db || true

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: Claudephobia.zip
          generate_release_notes: true
