name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Import signing certificate
        env:
          CERTIFICATE_P12: ${{ secrets.CERTIFICATE_P12 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -hex 16)

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "$CERTIFICATE_P12" | base64 --decode > $RUNNER_TEMP/cert.p12
          security import $RUNNER_TEMP/cert.p12 \
            -k "$KEYCHAIN_PATH" \
            -P "$CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign
          rm $RUNNER_TEMP/cert.p12

          # Allow codesign to access keychain without prompt
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db

      - name: Build app bundle
        run: |
          swift build -c release

          APP="Claudephobia.app"
          CONTENTS="${APP}/Contents"
          mkdir -p "${CONTENTS}/MacOS" "${CONTENTS}/Resources"

          cp .build/release/Claudephobia "${CONTENTS}/MacOS/Claudephobia"
          cp Resources/Info.plist "${CONTENTS}/Info.plist"

          if [ -f "Resources/AppIcon.icns" ]; then
            cp "Resources/AppIcon.icns" "${CONTENTS}/Resources/AppIcon.icns"
          fi

          # Sign with Developer ID + hardened runtime
          codesign --force --options runtime \
            --sign "Developer ID Application: Bruno Skendaj (53CZ5753ZD)" \
            "${APP}"

          codesign --verify --verbose "${APP}"

      - name: Notarize
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          zip -r Claudephobia.zip Claudephobia.app

          xcrun notarytool submit Claudephobia.zip \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --wait

          xcrun stapler staple Claudephobia.app

          # Re-zip with stapled ticket
          rm Claudephobia.zip
          zip -r Claudephobia.zip Claudephobia.app

      - name: Clean up keychain
        if: always()
        run: security delete-keychain $RUNNER_TEMP/signing.keychain-db || true

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: Claudephobia.zip
          generate_release_notes: true
